#!/usr/bin/env python
import subprocess
import multiprocessing
from multiprocessing import *
import os
import sys
import re
import reconf
from reconf import *
import time
from functools import wraps
import argparse
import ipaddr
import nmapxml
from nmapxml import *
import threading
from easyprocess import EasyProcess

parser = argparse.ArgumentParser(description='Run a bruteforce')
parser.add_argument('-ip', action='store', required=True, help='IP Address to be assessed')
parser.add_argument('-s', action='store', required=True, help='Service')
parser.add_argument('-a', action='store_true', required=False, help='ALL')
parser.add_argument('-H', action='store_true', required=False, help='hydra')
parser.add_argument('-n', action='store_true', required=False, help='ncrack')
parser.add_argument('-m', action='store_true', required=False, help='medusa')

args = parser.parse_args()
try:
    ip_address = ipaddr.IPAddress(args.ip)
except:
    print "Try again..."
    sys.exit()

stype = args.s

def chkcreds(EXECMD, TOUT=300):
    	#subprocess.call(EXECMD, shell=True)
	try:
		proc = EasyProcess(EXECMD).call(timeout=TOUT).stdout
	finally:
		pass

if args.a is True or args.m is True and args.H is False and args.n is False:
    medusasrv = ['csv','ftp','http','imap','mssql','mysql','nntp','pcanywhere','pop3','postgres','rexec','rlogin','rsh','smb','smtp','snmp','ssh','svn','telnet','vmauthd','vnc','web']
    if stype in medusasrv:
        try:
            outfile = f"{reconf.rsltpth}/{ip_address}_{stype}_medusa.txt"
            MEDUSA = f"medusa -h {ip_address} -U {reconf.usrlst} -P {reconf.pwdlst} -O {outfile} -e ns -v 4 -M {stype}"

            outfile = "%s/%s_%s_medusa.txt" % (reconf.rsltpth, ip_address, stype)
            chkcreds(MEDUSA, 300)
        finally:
            pass

if args.a is True or args.n is True and args.H is False and args.m is False:
    ncracksrv = ['ftp', 'ssh', 'telnet', 'http', 'pop3', 'smb', 'rdp', 'vnc']
    if stype in ncracksrv:
        try:
            outfile = f"{reconf.rsltpth}/{ip_address}_{stype}_ncrack.txt"
            NCRACK = f"ncrack -p {stype} -u {reconf.usrlst} -p {reconf.pwdlst} -T4 -oA {outfile} {ip_address}"

            outfile = "%s/%s_%s_ncrack.txt" % (reconf.rsltpth, ip_address, stype)
            chkcreds(NCRACK, 300)
        finally:
            pass

if args.a is True or args.H is True and args.n is False and args.m is False:
    hydrasrv = ['cisco', 'cisco-enable', 'cvs', 'firebird', 'ftp', 'ftps', 'http', 'icq', 'imap', 'irc', 'ldap2', 'ldap3', 'mssql', 'mysql', 'nntp', 'oracle-listener', 'oracle-sid', 'pcanywhere', 'pcnfs', 'pop3', 'postgres', 'rdp', 'redis', 'rexec', 'rlogin', 'rsh', 's7', 'sip', 'smb', 'smtp', 'smtp-enum', 'snmp', 'socks5', 'ssh', 'sshkey', 'svn', 'teamspeak', 'telnet', 'vmauthd', 'vnc', 'xmpp']
    if stype in hydrasrv:
        try:
            outfile = f"{reconf.rsltpth}/{ip_address}_{stype}_hydra.txt"
            HYDRA = f"hydra -L {reconf.usrlst} -P {reconf.pwdlst} -q -e ns -o {outfile} {ip_address} {stype}"

            outfile = "%s/%s_%s_hydra.txt" % (reconf.rsltpth, ip_address, stype)
            chkcreds(HYDRA, 300)
        finally:
            pass
